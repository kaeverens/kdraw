!function(n){function t(n){for(var t=[n[0]],o=1;o<n.length;++o)(n[o-1][0]!=n[o][0]||n[o-1][1]!=n[o][1])&&t.push(n[o]);for(var e=[n[0]],o=1;o<t.length-1;++o){var i=!1;if(t[o-1][1]==t[o][1])t[o][1]==t[o+1][1]&&(i=!0);else if(t[o][1]!=t[o+1][1]){var r=(t[o-1][0]-t[o][0])/(t[o-1][1]-t[o][1]),u=(t[o][0]-t[o+1][0])/(t[o][1]-t[o+1][1]);r==u&&(i=!0)}i||e.push(t[o])}return e.push(t[t.length-1]),console.log(JSON.stringify(n)),console.log(JSON.stringify(t)),console.log(JSON.stringify(e)),e}n.fn.kDraw=function(o){var e={pen:{colour:"#000",width:1,rotate:function(){var t=n(window).width(),o=n(window).height();return o>t}}},i=n(this);i.click(function(){function r(){b.remove(),m.remove()}function u(n,t){return h?[p-t,n]:[n,t]}function f(n,t){return h?[t,g-n]:[n,t]}function c(n,t){var o=u(n,t);w.moveTo(o[0],o[1])}function a(n,t){var o=u(n,t);w.lineTo(o[0],o[1])}function s(){w.clearRect(0,0,p,d),e=n.extend(e,o),h=e.rotate(),v=h?d:p,g=h?p:d;for(var t=0;t<y.length;++t){var i=y[t];switch(console.log(i),i.type){default:var r=i.p;w.beginPath(),c(r[0][0],r[0][1]);for(var u=1;u<r.length;++u)a(r[u][0],r[u][1]);w.stroke()}}}function l(n){function o(n){var t=f(n.offsetX,n.offsetY);r.push(t),w.beginPath(),c(i[0],i[1]),a(t[0],t[1]),w.stroke(),i=t}function e(){b.unbind("mousemove",o),b.unbind("mouseup",e),y.push({p:t(r)}),console.log(JSON.stringify(y))}var i=f(n.offsetX,n.offsetY),r=[i];b.mousemove(o),b.mouseup(e)}var p=n(window).width(),d=n(window).height(),h=0,v=p,g=d,b=n('<canvas width="'+p+'" height="'+d+'" style="position:fixed;left:0;top:0;right:0;bottom:0;background:#fff;"/>').appendTo("body"),w=b[0].getContext("2d");w.strokeStyle=e.pen.colour,w.lineWidth=e.pen.width;var m=n('<div style="position:fixed;right:5px;bottom:5px;"/>').appendTo("body");n("<button>Cancel</button>").click(function(){r()}).appendTo(m),n("<button>Reset</button>").click(function(){r(),i.click()}).appendTo(m),n("<button>Clear</button>").click(function(){y=[],s()}).appendTo(m),n("<button>OK</button>").click(function(){i.find("input").val(JSON.stringify(y)),r()}).appendTo(m);var y=JSON.parse(i.find("input").val()||"[]");return s(),b.mousedown(l),!1})}}(jQuery);
